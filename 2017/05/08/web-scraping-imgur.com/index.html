<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/stylesheets/shiori.css">
    <link rel="canonical" href="http://kaijento.github.io/2017/05/08/web-scraping-imgur.com/">
    <link rel="shortcut icon" href="/favicon.ico">
    <title>Web scraping: imgur.com | Shiori</title>
    
  </head>
  <body>

    <div class="navbar navbar-default navbar-static-top">

      <div class="container">
        <div class="navbar-header">
          <a href="/" class="navbar-brand">Shiori</a>
        </div>
        <div>
            <ul class="navbar-nav nav">
            <li><a href="/archive/">articles</a></li>
<li><a href="/categories/">categories</a></li>
<li><a href="/me/">me</a></li>
<li><a href="/feed.xml">rss</a></li>

          </ul>
          <ul class="navbar-nav nav navbar-right">
            <li><a href="https://twitter.com/kaijento">@kaijento</a></li>
<li><a href="https://github.com/kaijento">
    <svg height="18" viewBox="0 0 16 16" class="octicon-mark-github" version="1.1" width="24"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
  </a>
</li>

          </ul>
        </div>
      </div>
    </div>
    
    <div class="container post-body">
    
      <div class="row">
        
          <div class="col-sm-12">
            <div class="post-header">
  <!-- Emoji is not available outside markdown files, so using "include ribbon.html" instead -->
<img class="emoji" title=":ribbon:" alt=":ribbon:" src="/img/1f380.png" height="20" width="20" align="absmiddle">

  <h1 class="post-title-main"><a href="/2017/05/08/web-scraping-imgur.com/">Web scraping: imgur.com</a></h1>
  <p class="text-muted">08 May 2017</p>

<p class="text-right preview">
  
    
  <a href="/categories/python/">python</a>
  
    
  <a href="/categories/webscraping/">webscraping</a>
  
    
  <a href="/categories/requests/">requests</a>
  
    
  <a href="/categories/beautifulsoup/">beautifulsoup</a>
  
    
  <a href="/categories/json/">json</a>
  
    
  <a href="/categories/curl/">curl</a>
  
</p>


</div>
<div class="post-content">
  <p><em>I’m trying to “scrape” images from Imgur 
using BeautifulSoup and requests but I’m only getting the
first page of results. Why?</em></p>

<p>The example URL we’re given is <a href="http://imgur.com/r/funny">http://imgur.com/r/funny</a></p>

<p>The code uses <code class="highlighter-rouge">requests</code> to fetch the HTML and <code class="highlighter-rouge">BeautifulSoup</code>
with <code class="highlighter-rouge">html5lib</code> to parse it.</p>

<p>If you don’t have these install already you can use install them
using <code class="highlighter-rouge">pip</code> e.g.</p>

<p><code class="highlighter-rouge">pip install beautifulsoup4 requests html5lib --user</code></p>

<p>One thing to note is that <a href="https://api.imgur.com/">imgur.com has an api</a>.</p>
<ul>
  <li>You use it, taking the blue pill—the article ends.</li>
  <li>You take the red pill—you stay in Wonderland, 
and I show you how deep a <code class="highlighter-rouge">JSON</code> response goes.</li>
</ul>

<p>Remember: all I’m offering is the truth. Nothing more.</p>

<a name="developer-tools"></a>
<h2 class="section-header">
  <span id="developer-tools"></span>
  <a class="anchor" href="#developer-tools">“Developer Tools”</a>
</h2>

<p>Usually the first step to take is to debug the page in question
inside your browser using the <em>“Developer Tools”</em> (although 
currently it seems to called <em>“Web Developer”</em> in <code class="highlighter-rouge">Firefox</code>) mainly 
the <code class="highlighter-rouge">Inspector</code> tab and the <code class="highlighter-rouge">Network</code> tab.</p>

<p>So normally when you scroll down to the end of an <em>Imgur</em> results
page it will automatically load the next page of images.</p>

<p>I’m using <code class="highlighter-rouge">Firefox</code> as my browser (although <code class="highlighter-rouge">Chrome</code> also has 
<em>“Developer Tools”</em>) with Javascript disabled
(using the <code class="highlighter-rouge">NoScript</code> extension) so when I scroll to the
end of the page I see a <em>“loading”</em> icon and the next page
is never loaded.</p>

<p><img src="/img/1494227189-imgur-loading.png" alt="" /></p>

<p>This means that the <em>“load next page”</em> functionality
is implemented using Javascript. Neither <code class="highlighter-rouge">requests</code> 
nor the <code class="highlighter-rouge">urllib</code> modules can execute Javascript meaning
we will only get the first page of results when
using them to fetch the HTML.</p>

<p>One option is to debug the HTTP requests being made
by the Javascript and try to replicate them with <code class="highlighter-rouge">requests</code>.</p>

<p>To debug HTTP requests we can view the <code class="highlighter-rouge">Network</code> tab.</p>

<p>You may have heard of the <code class="highlighter-rouge">Inspector</code> tab which you can 
access by <em>right-clicking</em> on a page and selecting 
<code class="highlighter-rouge">Inspect Element</code>.</p>

<p><img src="/img/1494227500-imgur-inspect-element.png" alt="" /></p>

<p>Do note that the <code class="highlighter-rouge">Inspector</code> tab shows your browser’s representation
of the page after it has parsed the source HTML and as such it
may differ from the actual source HTML.</p>

<p>With the <code class="highlighter-rouge">Inspector</code> tab open we can simply select the <code class="highlighter-rouge">Network</code> tab.</p>

<p><img src="/img/1494227380-imgur-network-xhr.png" alt="" /></p>

<p>After opening the <code class="highlighter-rouge">Network</code> tab I have selected the <code class="highlighter-rouge">XHR</code> filter
to show only those type of requests. This stands for <code class="highlighter-rouge">XMLHttpRequest</code>
which is what the requests made by Javascript are classed as.</p>

<p>As we know the page is using Javascript to fetch the data we know
it will be an <code class="highlighter-rouge">XHR</code> request so viewing only those requests will
simplify things.</p>

<p>I then enable Javascript (as I have it disabled) and reload the page.
The <code class="highlighter-rouge">Network</code> tab will only show requests that have been made after it was
opened.</p>

<p>So we can see a <code class="highlighter-rouge">GET</code> request was made to 
<a href="http://imgur.com/r/funny/new/page/1/hit?scrolled">http://imgur.com/r/funny/new/page/1/hit?scrolled</a>
and its return type was <code class="highlighter-rouge">HTML</code>.</p>

<p>If we scroll down further to load the next page of images we see 
another <code class="highlighter-rouge">GET</code> request is made, this time to
<a href="http://imgur.com/r/funny/new/page/2/hit?scrolled">http://imgur.com/r/funny/new/page/2/hit?scrolled</a></p>

<p>All that changes in the URL is the page number i.e. <code class="highlighter-rouge">1 -&gt; 2</code> and as <code class="highlighter-rouge">1</code> gives 
us the second page of results we can assume that <code class="highlighter-rouge">0</code> will gives us the first i.e.</p>

<p><a href="http://imgur.com/r/funny/new/page/0/hit?scrolled">http://imgur.com/r/funny/new/page/0/hit?scrolled</a></p>

<p>This suggests we could loop through a <code class="highlighter-rouge">range()</code> of page numbers to build the
needed URLs and then parse out the image links from the HTML.</p>

<p>The images on the results page however are just <em>“preview”</em> images and not the 
actual content we’re looking for. Also, it’s not just <em>“images”</em> we’re dealing 
with as some are <em>“videos”</em>, some are <em>“albums”</em> of <em>“images”</em>.</p>

<p>So let’s scroll back up and click on one of the images to open the individual 
image page. Before clicking we will hit click the <em>“basket”</em> icon to the left 
of <code class="highlighter-rouge">Inspector</code> to clear out the <code class="highlighter-rouge">Network</code> tab to make it easier to focus
on the new requests being made.</p>

<p><img src="/img/1494279683-imgur-image-page.png" alt="" /></p>

<p>We can see a similar request is made to the previous <code class="highlighter-rouge">XHR</code> requests except <code class="highlighter-rouge">hit?scrolled</code>
is replaced with <code class="highlighter-rouge">hit.json</code> and we get back a <code class="highlighter-rouge">JSON</code> response.</p>

<p>If you click on the <code class="highlighter-rouge">Response</code> tab over on the right-hand side panel you can view
details about the response.</p>

<p>Another useful feature is that <em>right-click</em> on a request and <code class="highlighter-rouge">Copy as cURL</code>
which will give you the full <code class="highlighter-rouge">curl</code> command that can be used to replicate the
request which can be very useful for testing things out from the command-line.</p>

<p><img src="/img/1494280248-imgur-copy-as-curl.png" alt="" /></p>

<p>We can add <code class="highlighter-rouge">-o filename</code> to the end of the <code class="highlighter-rouge">curl</code> command to store the output 
into <code class="highlighter-rouge">filename</code> instead of just printing the result if needed.</p>

<p>Using the exact command is not always necessary but at the very least you will want 
to set the <code class="highlighter-rouge">User-Agent</code> header which is what we’ll do here.</p>

<p>We’re also going to pipe the result through <code class="highlighter-rouge">jq</code> which will <em>pretty-print</em> the <code class="highlighter-rouge">JSON</code>
and finally using shell redirection to write the result to file.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -A Mozilla/5.0 <span class="s1">'http://imgur.com/r/funny/new/page/0/hit.json'</span> | jq . &gt; imgur.json
</code></pre>
</div>

<p>You could of course use <code class="highlighter-rouge">requests</code> along with <code class="highlighter-rouge">json.dump()</code> to do it directly from
Python and there’s also <a href="https://httpie.org/">httpie</a>.</p>

<p>You may have also noticed the <code class="highlighter-rouge">Copy Response</code> entry in the <em>right-click</em> menu which
as the name suggests copies the response to your clipboard.</p>

<a name="json"></a>
<h2 class="section-header">
  <span id="json"></span>
  <a class="anchor" href="#json">JSON</a>
</h2>

<p>The <code class="highlighter-rouge">JSON</code> response received has a structure like</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"data"</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"id"</span><span class="p">:</span> <span class="mi">4735008625</span><span class="p">,</span>
      <span class="s2">"hash"</span><span class="p">:</span> <span class="s2">"pNuFUQQ"</span><span class="p">,</span>
      <span class="s2">"author"</span><span class="p">:</span> <span class="s2">"SlimJones123"</span><span class="p">,</span>
      <span class="s2">"account_id"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="s2">"account_url"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="s2">"title"</span><span class="p">:</span> <span class="s2">"Abra Kadraba Alakaslam"</span><span class="p">,</span>
      <span class="s2">"score"</span><span class="p">:</span> <span class="mi">18352</span><span class="p">,</span>
      <span class="s2">"size"</span><span class="p">:</span> <span class="mi">18087775</span><span class="p">,</span>
      <span class="s2">"views"</span><span class="p">:</span> <span class="s2">"18551"</span><span class="p">,</span>
      <span class="s2">"is_album"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s2">"album_cover"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="s2">"album_cover_width"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">"album_cover_height"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">"mimetype"</span><span class="p">:</span> <span class="s2">"image/gif"</span><span class="p">,</span>
      <span class="s2">"ext"</span><span class="p">:</span> <span class="s2">".gif"</span><span class="p">,</span>
      <span class="s2">"width"</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span>
      <span class="s2">"height"</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span>
      <span class="s2">"animated"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="s2">"looping"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="s2">"reddit"</span><span class="p">:</span> <span class="s2">"/r/funny/comments/6a02ma/abra_kadraba_alakaslam/"</span><span class="p">,</span>
      <span class="s2">"subreddit"</span><span class="p">:</span> <span class="s2">"funny"</span><span class="p">,</span>
      <span class="s2">"description"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="s2">"create_datetime"</span><span class="p">:</span> <span class="s2">"2017-05-05 14:42:36"</span><span class="p">,</span>
      <span class="s2">"bandwidth"</span><span class="p">:</span> <span class="s2">"312.50 GB"</span><span class="p">,</span>
      <span class="s2">"timestamp"</span><span class="p">:</span> <span class="s2">"2017-05-08 18:50:03"</span><span class="p">,</span>
      <span class="s2">"section"</span><span class="p">:</span> <span class="s2">"funny"</span><span class="p">,</span>
      <span class="s2">"nsfw"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s2">"prefer_video"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="s2">"video_source"</span><span class="p">:</span> <span class="s2">"https://www.instagram.com/p/BTW71oaA8DL/"</span><span class="p">,</span>
      <span class="s2">"video_host"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="s2">"num_images"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">data</code> has <code class="highlighter-rouge">100</code> entries meaning using <code class="highlighter-rouge">hit.json</code> gives us
<code class="highlighter-rouge">100</code> results per page and each entry contains lots of 
information, <code class="highlighter-rouge">hash</code>, <code class="highlighter-rouge">author</code>, <code class="highlighter-rouge">views</code>, etc.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>jq <span class="s1">'.data | length'</span> imgur.json
100
</code></pre>
</div>

<p>We could also use Python’s <code class="highlighter-rouge">json.load()</code> to get that information.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">json</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'imgur.json'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
<span class="mi">100</span>
</code></pre>
</div>

<p>… or just use <code class="highlighter-rouge">requests</code> to make the request as mentioned.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">requests</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s">'http://imgur.com/r/funny/new/page/0/hit.json'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span>   <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'user-agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0'</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'data'</span><span class="p">])</span>
<span class="mi">100</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">requests</code> has a <a href="http://docs.python-requests.org/en/master/user/quickstart/#json-response-content">.json()</a> 
method on response objects which saves us having to call <code class="highlighter-rouge">json.loads()</code> manually. 
Also note that HTTP header names are case-insensitive although feel free
to use <code class="highlighter-rouge">User-Agent</code> if you prefer.</p>

<p>If you’re not familiar with <code class="highlighter-rouge">JSON</code> it’s just a <em>“file format”</em> that is used
for passing data around. It looks similar to a Python structure and in this
case it’s valid Python too.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">j</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">...</span>   <span class="s">"data"</span><span class="p">:</span> <span class="p">[</span>
<span class="o">...</span>     <span class="p">{</span>
<span class="o">...</span>       <span class="s">"id"</span><span class="p">:</span> <span class="mi">4735008625</span><span class="p">,</span>
<span class="o">...</span>       <span class="s">"hash"</span><span class="p">:</span> <span class="s">"pNuFUQQ"</span>
<span class="o">...</span>     <span class="p">}</span>
<span class="o">...</span>   <span class="p">]</span>
<span class="o">...</span> <span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s">'dict'</span><span class="o">&gt;</span>
</code></pre>
</div>

<p>So we have a <code class="highlighter-rouge">dict</code> with the key <code class="highlighter-rouge">data</code> whose value is a <code class="highlighter-rouge">list</code>.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s">'data'</span><span class="p">])</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s">'list'</span><span class="o">&gt;</span>
</code></pre>
</div>

<p>And this is exactly what we get when from 
from the call to <code class="highlighter-rouge">.json()</code> or one of the <code class="highlighter-rouge">json.load</code> methods as
they turn <code class="highlighter-rouge">JSON</code> data into an equivalent Python structure.</p>

<p>So as mentioned above we’re not just dealing with single static images.
If you <em>“hover”</em> over the images in the list of results it shows you
the image <em>“type”</em> and the amount of views.</p>

<p><img src="/img/1494280811-imgur-alt.png" alt="" /></p>

<p>There appear to be <code class="highlighter-rouge">3</code> types</p>

<ul>
  <li><code class="highlighter-rouge">image</code></li>
  <li><code class="highlighter-rouge">animated</code></li>
  <li><code class="highlighter-rouge">gallery</code></li>
</ul>

<p>We can see this information inside the <code class="highlighter-rouge">JSON</code> response</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s2">"hash"</span>    <span class="err">:</span> <span class="s2">"pNuFUQQ"</span><span class="p">,</span>
<span class="s2">"is_album"</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="s2">"animated"</span><span class="err">:</span> <span class="kc">true</span>
</code></pre>
</div>

<p>So if <code class="highlighter-rouge">is_album</code> is <code class="highlighter-rouge">false</code> and <code class="highlighter-rouge">animated</code> is <code class="highlighter-rouge">false</code> it’s a
regular single image.</p>

<p>If <code class="highlighter-rouge">is_album</code> is <code class="highlighter-rouge">false</code> and <code class="highlighter-rouge">animated</code> is <code class="highlighter-rouge">true</code> like in this
example it’s a single <em>“video”</em>.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s2">"hash"</span>    <span class="err">:</span> <span class="s2">"pNuFUQQ"</span><span class="p">,</span>
<span class="s2">"mimetype"</span><span class="err">:</span> <span class="s2">"image/gif"</span><span class="p">,</span>
<span class="s2">"ext"</span>     <span class="err">:</span> <span class="s2">"gif"</span>
</code></pre>
</div>

<p>It does say it’s a <code class="highlighter-rouge">gif</code> but <em>Imgur</em> also serves <code class="highlighter-rouge">mp4</code>
versions of the <code class="highlighter-rouge">gif</code> files.</p>

<p>As we have the <code class="highlighter-rouge">hash</code> and the <code class="highlighter-rouge">ext</code> to build the URL we 
can simply replace <code class="highlighter-rouge">.gif</code> with <code class="highlighter-rouge">.mp4</code></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -I http://i.imgur.com/pNuFUQQ.gif
HTTP/1.1 200 OK
Last-Modified: Fri, 05 May 2017 14:42:40 GMT
ETag: <span class="s2">"b5467c538aa52d7ea066a7a7bfa6d574"</span>
Content-Type: image/gif
Fastly-Debug-Digest: 3a99bef1064a006c1e74d60486dfbae1791a3220c40c0fe005a08f3b801784bc
cache-control: public, max-age<span class="o">=</span>31536000
Content-Length: 18087775
<span class="o">[</span>...]
</code></pre>
</div>

<p>If we change extension to <code class="highlighter-rouge">mp4</code></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -I http://i.imgur.com/pNuFUQQ.mp4
HTTP/1.1 200 OK
Last-Modified: Fri, 05 May 2017 14:42:38 GMT
ETag: <span class="s2">"56a70bd6a18458c2a95c33934df5a692"</span>
Content-Type: video/mp4
Fastly-Debug-Digest: 95f433cb7680d8ce3e9289d820027d124861898b9723658660d494906c2eb2e7
cache-control: public, max-age<span class="o">=</span>31536000
Content-Length: 903448
<span class="o">[</span>...]
</code></pre>
</div>

<p>Note the substantial difference in the file size <code class="highlighter-rouge">903448</code> vs. <code class="highlighter-rouge">18087775</code> 
bytes. We will just use the <code class="highlighter-rouge">mp4</code> extension when we encounter a <code class="highlighter-rouge">gif</code>.</p>

<p>So that is <code class="highlighter-rouge">image</code> and <code class="highlighter-rouge">animated</code> types taken care of what about <code class="highlighter-rouge">album</code>?</p>

<p>I looked around to located an <code class="highlighter-rouge">album</code> with a large number of images and found
<a href="http://imgur.com/r/funny/rtYyh">http://imgur.com/r/funny/rtYyh</a></p>

<p><img src="/img/1494307287-imgur-load-more-images.png" alt="" /></p>

<p>If we look at the <code class="highlighter-rouge">Network</code> tab as we click on the <code class="highlighter-rouge">Load more images</code> button we
can see the <code class="highlighter-rouge">XHR</code> request being made.</p>

<p><img src="/img/1494307453-imgur-gallery-xhr.png" alt="" /></p>

<p>The request is made to 
<a href="http://imgur.com/ajaxalbums/getimages/rtYyh/hit.json">http://imgur.com/ajaxalbums/getimages/rtYyh/hit.json</a>
and we get back a <code class="highlighter-rouge">JSON</code> response with details about the images contained in the album.
Note that the <code class="highlighter-rouge">hash</code> (i.e. <code class="highlighter-rouge">rtYyh</code>) is passed along in the <code class="highlighter-rouge">URL</code> itself.</p>

<p>We’ll use the <code class="highlighter-rouge">curl | jq</code> combo from earlier to get a <em>pretty-printed</em> version of the
<code class="highlighter-rouge">JSON</code> response saved to disk.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -A Mozilla/5.0 <span class="s1">'http://imgur.com/ajaxalbums/getimages/rtYyh/hit.json'</span> | jq . &gt; imgur-gallery.json
</code></pre>
</div>

<p><a href="https://httpie.org/">httpie</a> mentioned earlier is a <em>“curl-like”</em> tool
written in Python that gives you a single <code class="highlighter-rouge">http</code> command which you could
use instead.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>http --pretty format http://imgur.com/... User-Agent:Mozilla/5.0 &gt; imgur-gallery.json
</code></pre>
</div>

<p>Either way the <code class="highlighter-rouge">JSON</code> response has a structure like</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"data"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"count"</span><span class="err">:</span> <span class="mi">26</span><span class="p">,</span>
    <span class="s2">"images"</span><span class="err">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">"hash"</span><span class="p">:</span> <span class="s2">"5MXcg9i"</span><span class="p">,</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
        <span class="s2">"description"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="s2">"width"</span><span class="p">:</span> <span class="mi">701</span><span class="p">,</span>
        <span class="s2">"height"</span><span class="p">:</span> <span class="mi">943</span><span class="p">,</span>
        <span class="s2">"size"</span><span class="p">:</span> <span class="mi">6597</span><span class="p">,</span>
        <span class="s2">"ext"</span><span class="p">:</span> <span class="s2">".png"</span><span class="p">,</span>
        <span class="s2">"animated"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="s2">"prefer_video"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="s2">"looping"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="s2">"datetime"</span><span class="p">:</span> <span class="s2">"2017-05-03 06:00:48"</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">"hash"</span><span class="p">:</span> <span class="s2">"otDOcL6"</span><span class="p">,</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
</code></pre>
</div>

<p>So we have the <code class="highlighter-rouge">count</code> of images in the album and the
list of images with each <code class="highlighter-rouge">hash</code> and <code class="highlighter-rouge">ext</code> meaning we can 
build their URL e.g. <code class="highlighter-rouge">http://i.imgur.com/hash.ext</code></p>

<p>Do recall that we got <code class="highlighter-rouge">100</code> results from our <code class="highlighter-rouge">page/N/hit.json</code> which
would suggest there is a limit of <code class="highlighter-rouge">100</code> results per call. If an 
album has multiple <code class="highlighter-rouge">Load more images</code> buttons there is probably a 
similar <em>“page”</em> type syntax for the <code class="highlighter-rouge">getimages/hash/hit.json</code> call
however without debugging such a page we cannot be sure how it works.</p>

<a name="code"></a>
<h2 class="section-header">
  <span id="code"></span>
  <a class="anchor" href="#code">Code</a>
</h2>

<p>So now that we know what requests are being made we can attempt
to replicate them with Python.</p>

<p>We will first show the output.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>python imgur.py | tee imgur.log
http://i.imgur.com/rNM1Z0V.jpg
http://i.imgur.com/SOnDLwR.mp4
http://i.imgur.com/n3PXWRe.mp4
http://i.imgur.com/9i1aYWN.jpg
http://i.imgur.com/JaeMo6M.mp4
http://i.imgur.com/sH4DqXA.jpg
http://i.imgur.com/uw9ppv4.png
http://i.imgur.com/xF0mdmc.mp4
http://i.imgur.com/pNuFUQQ.mp4
http://i.imgur.com/k4j6ZNZ.jpg
http://i.imgur.com/Ac5p6fB.jpg
http://i.imgur.com/2wdzJkM.jpg
http://i.imgur.com/HP3nCsV.jpg
http://i.imgur.com/90p9w6i.jpg
http://i.imgur.com/3V9qV6w.jpg
http://i.imgur.com/ZxfEVSF.jpg
http://i.imgur.com/CH0FWLj.jpg
http://i.imgur.com/vUfHVz2.jpg
http://i.imgur.com/1Ici9Si.jpg
http://i.imgur.com/ZSyEt89.jpg
<span class="o">[</span>...]
<span class="gp">$ </span>wc -l imgur.log
152 imgur.log
</code></pre>
</div>

<p>So from the <code class="highlighter-rouge">100</code> entries we ended up with <code class="highlighter-rouge">152</code> <em>“images</em>” due to some
of them being albums containing multiple <em>“images”</em>.</p>

<p>Here is the code.</p>

<div class="language-python-nu highlighter-rouge"><pre class="highlight"><div class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</div><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">imgur</span>     <span class="o">=</span> <span class="s">'http://i.imgur.com/{}{}'</span>
<span class="n">page_api</span>  <span class="o">=</span> <span class="s">'http://imgur.com/r/funny/new/page/{}/hit.json'</span>
<span class="n">album_api</span> <span class="o">=</span> <span class="s">'http://imgur.com/ajaxalbums/getimages/{}/hit.json'</span>

<span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'user-agent'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Mozilla/5.0'</span>
    
    <span class="n">url</span> <span class="o">=</span> <span class="n">page_api</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="s">'data'</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s">'ext'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'.gif'</span><span class="p">:</span>
            <span class="n">entry</span><span class="p">[</span><span class="s">'ext'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'.mp4'</span>
        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s">'is_album'</span><span class="p">]:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">album_api</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s">'hash'</span><span class="p">])</span>
            <span class="n">j</span>   <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'images'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">image</span><span class="p">[</span><span class="s">'ext'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'.gif'</span><span class="p">:</span>
                    <span class="n">image</span><span class="p">[</span><span class="s">'ext'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'.mp4'</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">imgur</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s">'hash'</span><span class="p">],</span> <span class="n">image</span><span class="p">[</span><span class="s">'ext'</span><span class="p">])</span>
                <span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">imgur</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s">'hash'</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'ext'</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>So firstly you’ll notice there is no <code class="highlighter-rouge">BeautifulSoup</code>.</p>

<p>This is because we’re kind of making <em>“API calls”</em> directly and 
getting the data in <code class="highlighter-rouge">JSON</code> meaning there is no <code class="highlighter-rouge">HTML</code> involved
at all.</p>

<p>The <code class="highlighter-rouge"><span class="p">{}</span></code> in our <code class="highlighter-rouge">imgur</code> variable is a <em>placeholder</em> for use with 
<a href="https://docs.python.org/3/library/stdtypes.html#str.format">str.format()</a>.</p>

<p>Each <code class="highlighter-rouge"><span class="p">{}</span></code> gets replaced with the corresponding argument passed to
the <code class="highlighter-rouge">format()</code> call e.g.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">imgur</span> <span class="o">=</span> <span class="s">'http://i.imgur.com/{}{}'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imgur</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">'hash'</span><span class="p">,</span> <span class="s">'.ext'</span><span class="p">)</span>
<span class="s">'http://i.imgur.com/hash.ext'</span>
</code></pre>
</div>

<p>Obviously in this example we could also use <code class="highlighter-rouge">imgur + hash + ext</code> as
we just need to append to the end but perhaps a better example of
<code class="highlighter-rouge">format()</code> is when you need variable data <em>“inside”</em> a string.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">page_api</span> <span class="o">=</span> <span class="s">'http://imgur.com/r/funny/new/page/{}/hit.json'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">page_api</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="s">'http://imgur.com/r/funny/new/page/0/hit.json'</span>
</code></pre>
</div>

<p>When making multiple requests with <code class="highlighter-rouge">requests</code> you’ll usually want to use a 
<a href="http://docs.python-requests.org/en/latest/user/advanced/#session-objects">session object</a>
to maintain <em>“state”</em> and keep track of cookies.</p>

<p>You’ll also pretty much always want to set the <code class="highlighter-rouge">User-Agent</code> header 
which we set here to <code class="highlighter-rouge">Mozilla/5.0</code> as the default <code class="highlighter-rouge">User-Agent</code> tends
to be blocked.</p>

<p>So we <code class="highlighter-rouge">get()</code> the first page of results from <code class="highlighter-rouge">page/0/hit.json</code> however
you could use a loop to process multiple pages.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">page_api</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre>
</div>

<p>We then loop through each entry changing any <code class="highlighter-rouge">.gif</code> extension to <code class="highlighter-rouge">.mp4</code> 
but you can of course skip this part if you wish.</p>

<p>If the <code class="highlighter-rouge">entry['is_album']</code> we then generate the URL to the 
<code class="highlighter-rouge">ajaxalbums/getimages</code> <em>“API call”</em> and process the resulting 
<code class="highlighter-rouge">['data']['images']</code> list.</p>

<p>There is some slight code duplication here which suggests we
could create a function but we’ll leave that for now.</p>

<p>The final goal is probably to save the images to disk which you could 
implement <a href="http://docs.python-requests.org/en/latest/user/quickstart/#raw-response-content">using requests</a>
instead of just printing the URLs.</p>

</div>

  
    <div class="post-navs row">
      
        <div class="col-md-6 post-nav">
          <h3 class="section-header">
            Older
            <!--<span class="text-muted"> &middot; </span>-->
            <a href="/archive">View Archive (62)</a>
          </h3>
          <h2 class="post-title-link"><a href="/2017/05/06/web-scraping-nasa-image-of-the-day/">Web scraping: NASA Image of the Day</a></h2>
          <p class="preview">The goal is trying to <em>“scrape”</em> images from 
<a href="https://www.nasa.gov/multimedia/imagegallery/iotd.html">NASA’s Image of the Day page</a> 
using Python’s <code class="highlighter-rouge">BeautifulSoup</code> module. The images 
are there when I look in the <code class="highlighter-rouge">Inspector</code> tab but they’re
not there when I fetch the page using <code class="highlighter-rouge">requests</code>. What am
I doing wrong?</p>


        </div>
      
      
        <div class="col-md-6 post-nav">
          <h3 class="section-header">
            Newer
            
          </h3>
          <h2 class="post-title-link"><a href="/2017/05/10/bash-files-that-contain-all-lines/">bash: files that contain all lines from file</a></h2>
          <p class="preview"><em>Given <code class="highlighter-rouge">file-a</code> I need to find all files recursively (“using bash”)
that contain all of the lines from <code class="highlighter-rouge">file-a</code> regardless of order.
How can I do this?</em></p>


        </div>
      
    </div>
  

<div class="post-footer">
  <center><strong>Hello? Is it me you're looking for?</strong> 
<p>
  <a href="mailto:karl.genockey.thornton@gmail.com">e-mail</a>
  <a href="https://github.com/kaijento">github</a>
  <strong>♥</strong> 
  <a href="https://paypal.me/kaijento">paypal</a>
  <a href="https://twitter.com/kaijento">twitter</a> 
</p>
<p>
<small>1GVHM3rfQ46k15RZsfnE4xzmKk7NCFwRaT</small>
</p>
</center>

</div>

          </div>
        
      </div>
      <div class="row footer">
        <div class="col-sm-12 text-center">
          &copy;2017.
Built with <a href="http://jekyllrb.com/">Jekyll</a> and
<a href="https://github.com/ellekasai/shiori">Shiori Theme</a>.

        </div>
      </div>
    </div>
    
  </body>
</html>
