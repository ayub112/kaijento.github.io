<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/stylesheets/shiori.css">
    <link rel="canonical" href="http://kaijento.github.io/2017/03/23/web-scraping-mangastream.com/">
    <link rel="shortcut icon" href="/favicon.ico">
    <title>Web scraping: mangastream.com | Shiori</title>
    
  </head>
  <body>

    <div class="navbar navbar-default navbar-static-top">

      <div class="container">
        <div class="navbar-header">
          <a href="/" class="navbar-brand">Shiori</a>
        </div>
        <div>
            <ul class="navbar-nav nav">
            <li><a href="/archive/">articles</a></li>
<li><a href="/categories/">categories</a></li>
<li><a href="/me/">me</a></li>
<li><a href="/feed.xml">rss</a></li>

          </ul>
          <ul class="navbar-nav nav navbar-right">
            <li><a href="https://twitter.com/kaijento">@kaijento</a></li>
<li><a href="https://github.com/kaijento">
    <svg height="18" viewBox="0 0 16 16" class="octicon-mark-github" version="1.1" width="24"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
  </a>
</li>

          </ul>
        </div>
      </div>
    </div>
    
    <div class="container post-body">
    
      <div class="row">
        
          <div class="col-sm-12">
            <div class="post-header">
  <!-- Emoji is not available outside markdown files, so using "include ribbon.html" instead -->
<img class="emoji" title=":ribbon:" alt=":ribbon:" src="/img/1f380.png" height="20" width="20" align="absmiddle">

  <h1 class="post-title-main"><a href="/2017/03/23/web-scraping-mangastream.com/">Web scraping: mangastream.com</a></h1>
  <p class="text-muted">23 Mar 2017</p>

<p class="text-right preview">
  
    
  <a href="/categories/python/">python</a>
  
    
  <a href="/categories/webscraping/">webscraping</a>
  
    
  <a href="/categories/beautifulsoup/">beautifulsoup</a>
  
    
  <a href="/categories/requests/">requests</a>
  
    
  <a href="/categories/scrapy/">scrapy</a>
  
</p>


</div>
<div class="post-content">
  <p>Somebody was asking for assistance in scraping all of the comic images
from a particular “chapter” on a mangastream.com comic using Python so they
could read it offline.</p>

<p>The example URL given was 
<a href="http://mangastream.com/r/demons_plan/010/3997/">http://mangastream.com/r/demons_plan/010/3997/</a></p>

<p>Let’s open up in our browser and check out the <code class="highlighter-rouge">Inspector</code> tab. We can use the selector tool 
which allows us to select a particular item on the page and it will jump to where in the DOM 
that item is defined.</p>

<p>Do note however that the DOM may differ from the actual HTML source. The DOM is generated by your
browser parsing the HTML source (which may contain javascript, etc) so while a useful tool
you should always check what HTML you are getting from the client you’re using.</p>

<p><img src="/img/1490256404-mangastream-comic.png" alt="" /></p>

<p>So for the comic image itself we have:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/2"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;img</span> <span class="na">id=</span><span class="s">"manga-page"</span> <span class="na">src=</span><span class="s">"http://img.mangastream.com/cdn/manga/138/3997/01.png"</span><span class="nt">&gt;&lt;/a&gt;</span>
</code></pre>
</div>

<p>We’ll be using Python’s <code class="highlighter-rouge">requests</code> to fetch the HTML and <code class="highlighter-rouge">BeautifulSoup</code> (package name <code class="highlighter-rouge">beautifulsoup4</code>)
to parse it.</p>

<p>When “scraping” with <code class="highlighter-rouge">requests</code> you’ll usually want to use a 
<a href="http://docs.python-requests.org/en/latest/user/advanced/#session-objects">Session Object</a>.</p>

<p>It keeps track of cookies, etc and it means we can set headers once for all 
our requests without having to pass them manually each time e.g. <code class="highlighter-rouge">requests.get(url, headers={...})</code></p>

<p>So let’s open an interactive session and test it out:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">requests</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span>   <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'user-agent'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Mozilla/5.0'</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">r</span>    <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://mangastream.com/r/demons_plan/010/3997/'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s">'html5lib'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'img'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s">'manga-page'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span>
<span class="o">&lt;</span><span class="n">img</span> <span class="nb">id</span><span class="o">=</span><span class="s">"manga-page"</span> <span class="n">src</span><span class="o">=</span><span class="s">"http://img.mangastream.com/cdn/manga/138/3997/01.png"</span><span class="o">/&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span><span class="o">.</span><span class="n">attrs</span>
<span class="p">{</span><span class="s">'src'</span><span class="p">:</span> <span class="s">'http://img.mangastream.com/cdn/manga/138/3997/01.png'</span><span class="p">,</span> <span class="s">'id'</span><span class="p">:</span> <span class="s">'manga-page'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span><span class="p">[</span><span class="s">'src'</span><span class="p">]</span>
<span class="s">'http://img.mangastream.com/cdn/manga/138/3997/01.png'</span>
</code></pre>
</div>

<a name="user-agent"></a>
<h2 class="section-header">
  <span id="user-agent"></span>
  <a class="anchor" href="#user-agent">User-Agent</a>
</h2>

<p>The first thing you’ll normally want to do is set the value of the <code class="highlighter-rouge">User-Agent</code> header. 
It’s most common for requests to be blocked by filtering on the value of this header 
so we set it to something that matches an <em>“actual”</em> browser.</p>

<a name="html5lib"></a>
<h2 class="section-header">
  <span id="html5lib"></span>
  <a class="anchor" href="#html5lib">html5lib</a>
</h2>

<p>When creating a <code class="highlighter-rouge">BeautifulSoup</code> object you must specify what parser to use. The default
is <code class="highlighter-rouge">html.parser</code> which has several issues so I prefer to use <code class="highlighter-rouge">html5lib</code>. You will have 
to install it separately. There is also <code class="highlighter-rouge">lxml</code>.</p>

<a name="find"></a>
<h2 class="section-header">
  <span id="find"></span>
  <a class="anchor" href="#find">find()</a>
</h2>

<p>So <code class="highlighter-rouge">find()</code> returns the first matching Tag. It looks like we just got a string back but
we can see by checking <code class="highlighter-rouge">type()</code> that is it a <code class="highlighter-rouge">bs4.element.Tag</code> object.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">bs4</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">Tag</span><span class="s">'&gt; </span><span class="err">
</span></code></pre>
</div>

<p>I tend to choose the name of the tag as the variable name to store it in e.g. <code class="highlighter-rouge">img = find('img', ...)</code>
but feel free to choose your own naming scheme.</p>

<p>BeautifulSoup provides “shorthand” syntax for several operations e.g. passing <code class="highlighter-rouge">id='foo'</code> to 
match a particular value for the <code class="highlighter-rouge">id</code> attribute.</p>

<p>This is shorthand for <code class="highlighter-rouge"><span class="p">{</span><span class="err">'id':</span><span class="w"> </span><span class="err">'foo'</span><span class="p">}</span></code> i.e. you can pass a dict of attribute names/values
to match against when searching.</p>

<p>There is <code class="highlighter-rouge">class_=</code> (note the underscore) because <code class="highlighter-rouge">class</code> is special to Python, however
if you pass a 2nd argument (not by name) e.g. <code class="highlighter-rouge">find('tag', 'value')</code> it will 
default to matching against class. That is to say:</p>

<p><code class="highlighter-rouge">find('tag', 'value')</code> is the same as <code class="highlighter-rouge">find('tag', {'class': 'value'})</code></p>

<p><code class="highlighter-rouge">.attrs</code> is a dict that holds the attribute names and values however you can use dict-indexing
on the Tag object itself to access values.</p>

<a name="find_all"></a>
<h2 class="section-header">
  <span id="find_all"></span>
  <a class="anchor" href="#find_all">find_all()</a>
</h2>

<p>How specific you need to be when isolating particular items depends on the structure of the HTML 
you’re working with. In this case the <code class="highlighter-rouge">&lt;img&gt;</code> tags we want are the only tags on the page that match 
so we can omit the tagname from the <code class="highlighter-rouge">find()</code>. Each page also appears to have a single <code class="highlighter-rouge">&lt;img&gt;</code> tag
which we can check by using <code class="highlighter-rouge">find_all()</code> which returns a “list” of Tag objects.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">'manga-page'</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">img</span> <span class="nb">id</span><span class="o">=</span><span class="s">"manga-page"</span> <span class="n">src</span><span class="o">=</span><span class="s">"http://img.mangastream.com/cdn/manga/138/3997/01.png"</span><span class="o">/&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">'manga-page'</span><span class="p">)</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">img</span> <span class="nb">id</span><span class="o">=</span><span class="s">"manga-page"</span> <span class="n">src</span><span class="o">=</span><span class="s">"http://img.mangastream.com/cdn/manga/138/3997/01.png"</span><span class="o">/&gt;</span><span class="p">]</span>
</code></pre>
</div>

<a name="downloading-the-image"></a>
<h2 class="section-header">
  <span id="downloading-the-image"></span>
  <a class="anchor" href="#downloading-the-image">Downloading the image</a>
</h2>

<p><code class="highlighter-rouge">img['src']</code> holds the URL pointing to the comic image we want so we can just pass that to
<code class="highlighter-rouge">s.get()</code> and <code class="highlighter-rouge">write(r.content)</code> out to file. Do note we are opening the file using <code class="highlighter-rouge">b</code> for
binary-mode which is important.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">comic_page</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="s">'src'</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'demons_plan_01.png'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comic_page</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="o">...</span>
</code></pre>
</div>

<p>If you want to steam the file (perhaps it’s too large to fit into memory) you can use the 
example given in the docs 
<a href="http://docs.python-requests.org/en/latest/user/quickstart/#raw-response-content">here</a>.</p>

<p>Let’s check what we saved is a valid PNG file:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">imghdr</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imghdr</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="s">'demons_plan_01.png'</span><span class="p">)</span>
<span class="s">'png'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">subprocess</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">'file'</span><span class="p">,</span> <span class="s">'demons_plan_01.png'</span><span class="p">])</span>
<span class="s">'demons_plan_01.png: PNG image data, 887 x 1300, 8-bit colormap, non-interlaced</span><span class="se">\n</span><span class="s">'</span>
</code></pre>
</div>

<a name="navigating-the-pages"></a>
<h2 class="section-header">
  <span id="navigating-the-pages"></span>
  <a class="anchor" href="#navigating-the-pages">Navigating the pages</a>
</h2>

<p>We’ve successfully downloaded Page 1 so how do we get all of the pages?</p>

<p>Let’s check again with the <code class="highlighter-rouge">Inspector</code> tab:</p>

<p><img src="/img/1490262341-mangastream-pages.png" alt="" /></p>

<p>And what it looks like on the inside:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"btn-group btn-reader-page"</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-primary dropdown-toggle"</span> <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
Page 1 <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"caret"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/1"</span><span class="nt">&gt;</span>First Page (1)<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/2"</span><span class="nt">&gt;</span>Page 2<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/3"</span><span class="nt">&gt;</span>Page 3<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/4"</span><span class="nt">&gt;</span>Page 4<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/5"</span><span class="nt">&gt;</span>Page 5<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/6"</span><span class="nt">&gt;</span>Page 6<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/7"</span><span class="nt">&gt;</span>Page 7<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/8"</span><span class="nt">&gt;</span>Page 8<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/9"</span><span class="nt">&gt;</span>Page 9<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/10"</span><span class="nt">&gt;</span>Page 10<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/11"</span><span class="nt">&gt;</span>Page 11<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/12"</span><span class="nt">&gt;</span>Page 12<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/13"</span><span class="nt">&gt;</span>Page 13<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/14"</span><span class="nt">&gt;</span>Page 14<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/15"</span><span class="nt">&gt;</span>Page 15<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/16"</span><span class="nt">&gt;</span>Page 16<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/20"</span><span class="nt">&gt;</span>Last Page (20)<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<a name="pls-y-u-no-seventeen"></a>
<h2 class="section-header">
  <span id="pls-y-u-no-seventeen"></span>
  <a class="anchor" href="#pls-y-u-no-seventeen">pls y u no seventeen?</a>
</h2>

<p>So firstly we note that the links are inside <code class="highlighter-rouge">&lt;div class="btn-group btn-reader-page"&gt;</code>.
The second thing to note is that not all of the pages are there. It jumps from <code class="highlighter-rouge">Page 16</code>
to <code class="highlighter-rouge">Page 20</code>.</p>

<p>Each of the links follows the same naming pattern so let’s open up 
<a href="http://mangastream.com/r/demons_plan/010/3997/17">http://mangastream.com/r/demons_plan/010/3997/17</a>
to see if it exists?</p>

<p>The answer is that yes, it does. This means that instead of extracting the links we
will just have to extract the number of the last page and contruct the URLs manually.</p>

<p>The last page number is available in both the URL of the <code class="highlighter-rouge">href</code> attribute and the text
content of the tag itself. The particular <code class="highlighter-rouge">&lt;a&gt;</code> we’re after is the last one inside the 
<code class="highlighter-rouge">&lt;div&gt;</code>.</p>

<a name="findfind_all"></a>
<h2 class="section-header">
  <span id="findfind_all"></span>
  <a class="anchor" href="#findfind_all">find().find_all()</a>
</h2>

<p>So we could first <code class="highlighter-rouge">find()</code> the <code class="highlighter-rouge">&lt;div&gt;</code> and then <code class="highlighter-rouge">find_all()</code> the <code class="highlighter-rouge">&lt;a&gt;</code> tags taking 
the last one:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'div'</span><span class="p">,</span> <span class="s">'btn-group btn-reader-page'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">div</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/20"</span><span class="o">&gt;</span><span class="n">Last</span> <span class="n">Page</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre>
</div>

<p><strong>Note</strong> that we’re calling <code class="highlighter-rouge">div.find_all()</code> and 
<strong>not</strong> <code class="highlighter-rouge">soup.find_all()</code>.  Calling <code class="highlighter-rouge">soup.find_all()</code> would search the whole 
document whereas calling it on the <code class="highlighter-rouge">div</code> variable will only search starting 
from the tag it represents i.e. <code class="highlighter-rouge">&lt;div class="btn-group btn-reader-page"&gt;</code></p>

<p>We could have also chained the calls without the need for the <code class="highlighter-rouge">div</code> variable:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'div'</span><span class="p">,</span> <span class="s">'btn-group btn-reader-page'</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre>
</div>

<a name="select"></a>
<h2 class="section-header">
  <span id="select"></span>
  <a class="anchor" href="#select">select()</a>
</h2>

<p>Another option is <code class="highlighter-rouge">select()</code> which allows you to use <code class="highlighter-rouge">CSS Selectors</code>:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/20"</span><span class="o">&gt;</span><span class="n">Last</span> <span class="n">Page</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">.btn-reader-page</code> matches any tag that has <code class="highlighter-rouge">btn-reader-page</code> as a “word” inside their
<code class="highlighter-rouge">class</code> attribute.</p>

<ul>
  <li><code class="highlighter-rouge">.</code> is for matching against <code class="highlighter-rouge">class</code></li>
  <li><code class="highlighter-rouge">#</code> is for matching against <code class="highlighter-rouge">id</code></li>
</ul>

<p>We could have been explicit and used <code class="highlighter-rouge">div.btn-reader-page</code> to specify the tag type. Also
<code class="highlighter-rouge">one two</code> means that <code class="highlighter-rouge">two</code> must be a descendant of <code class="highlighter-rouge">one</code>. <code class="highlighter-rouge">a</code> is <code class="highlighter-rouge">two</code> in our selector
meaning that the <code class="highlighter-rouge">a</code> tags must be descendants.</p>

<a name="string"></a>
<h2 class="section-header">
  <span id="string"></span>
  <a class="anchor" href="#string">string=</a>
</h2>

<p>Another useful tool is the <code class="highlighter-rouge">string=</code> named argument of the find methods that tests 
against the string/text content of a tag.  You can give a string (which will test 
for an <strong>exact</strong> match) or you can also pass an <code class="highlighter-rouge">re</code> Pattern object:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'^Last Page </span><span class="err">\</span><span class="s">(</span><span class="err">\</span><span class="s">d+</span><span class="err">\</span><span class="s">)$'</span><span class="p">))</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/20"</span><span class="o">&gt;</span><span class="n">Last</span> <span class="n">Page</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre>
</div>

<a name="extracting-the-last-page-number"></a>
<h2 class="section-header">
  <span id="extracting-the-last-page-number"></span>
  <a class="anchor" href="#extracting-the-last-page-number">extracting the last page number</a>
</h2>

<p>We’ll choose <code class="highlighter-rouge">select()</code> here because it’s less typing and I’m lazy:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"http://mangastream.com/r/demons_plan/010/3997/20"</span><span class="o">&gt;</span><span class="n">Last</span> <span class="n">Page</span> <span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<span class="s">'Last Page (20)'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'href'</span><span class="p">]</span>
<span class="s">'http://mangastream.com/r/demons_plan/010/3997/20'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'href'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="p">[</span><span class="s">'http:'</span><span class="p">,</span> <span class="s">''</span><span class="p">,</span> <span class="s">'mangastream.com'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="s">'demons_plan'</span><span class="p">,</span> <span class="s">'010'</span><span class="p">,</span> <span class="s">'3997'</span><span class="p">,</span> <span class="s">'20'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'href'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="s">'20'</span>
</code></pre>
</div>

<p>It’s simpler to extract the page number from the URL than it is from the <code class="highlighter-rouge">.text</code>.
We could then create a <code class="highlighter-rouge">for</code> loop to build the URLs:</p>

<a name="building-the-url-list"></a>
<h2 class="section-header">
  <span id="building-the-url-list"></span>
  <a class="anchor" href="#building-the-url-list">building the URL list</a>
</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'href'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<span class="o">...</span>     <span class="s">'http://mangastream.com/r/demons_plan/010/3997/{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="o">...</span> 
<span class="s">'http://mangastream.com/r/demons_plan/010/3997/2'</span>
<span class="s">'http://mangastream.com/r/demons_plan/010/3997/3'</span>
<span class="s">'http://mangastream.com/r/demons_plan/010/3997/4'</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="s">'http://mangastream.com/r/demons_plan/010/3997/20'</span>
</code></pre>
</div>

<p>Note that we need to call <code class="highlighter-rouge">int()</code> on <code class="highlighter-rouge">last</code> and I’ve also chopped the output for brevity, 
it prints all pages 2 - 20.</p>

<a name="there-is-a-lot-of-new-code-here"></a>
<h2 class="section-header">
  <span id="there-is-a-lot-of-new-code-here"></span>
  <a class="anchor" href="#there-is-a-lot-of-new-code-here">THERE IS A LOT OF NEW CODE HERE</a>
</h2>

<p>So we know how to save a page image and how to build a list of all the remaining pages.
Let’s put it all together:</p>

<p><code class="highlighter-rouge">mangastream.com.py</code></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span>   <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'MKDIR:'</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="c"># Python &gt;=3.2</span>
<span class="c">#print('MKDIR: ', dirname)</span>
<span class="c">#os.makedirs(dirname, exist_ok=True)</span>
    
<span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'user-agent'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Mozilla/5.0'</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'GET:   '</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">r</span>    <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s">'html5lib'</span><span class="p">)</span>

    <span class="n">img</span>       <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">'manga-page'</span><span class="p">)</span>
    <span class="n">image_url</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="s">'src'</span><span class="p">]</span>
    <span class="n">filename</span>  <span class="o">=</span> <span class="n">image_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path</span>      <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'GET:   '</span><span class="p">,</span> <span class="n">image_url</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'CREATE:'</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="n">last</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'href'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span> <span class="o">+</span> <span class="s">'/{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'GET:   '</span><span class="p">,</span> <span class="n">next_page</span><span class="p">)</span>
        <span class="n">r</span>    <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">next_page</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s">'html5lib'</span><span class="p">)</span>

        <span class="n">img</span>       <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">'manga-page'</span><span class="p">)</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="s">'src'</span><span class="p">]</span>
        <span class="n">filename</span>  <span class="o">=</span> <span class="n">image_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">path</span>      <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'GET:   '</span><span class="p">,</span> <span class="n">image_url</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'CREATE:'</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</code></pre>
</div>

<p>Let’s run it:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>python mangastream.com.py http://mangastream.com/r/demons_plan/010/3997/
MKDIR:  demons_plan/010
GET:    http://mangastream.com/r/demons_plan/010/3997/
GET:    http://img.mangastream.com/cdn/manga/138/3997/01.png
CREATE: demons_plan/010/01.png
GET:    http://mangastream.com/r/demons_plan/010/3997/2
GET:    http://img.mangastream.com/cdn/manga/138/3997/01a.jpg
CREATE: demons_plan/010/01a.jpg
<span class="o">[</span>...]
GET:    http://mangastream.com/r/demons_plan/010/3997/20
GET:    http://img.mangastream.com/cdn/manga/138/3997/19.png
CREATE: demons_plan/010/19.png
</code></pre>
</div>

<p>The output has been trimmed for brevity but you may notice that the filename on comic
#2 is <code class="highlighter-rouge">01a.jpg</code> and the last filename is <code class="highlighter-rouge">19.png</code>. You could generate your own filenames
instead if you wanted to.</p>

<a name="funkytime"></a>
<h2 class="section-header">
  <span id="funkytime"></span>
  <a class="anchor" href="#funkytime">funkytime!</a>
</h2>

<p>So great, it works! However the code can be cleaned up a bit.  What we have inside the <code class="highlighter-rouge">for</code>
loop is essentially the same as the code before it. Having duplicated code like this
is usually a sign to put it inside a function, so let’s give it a try:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span>   <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">def</span> <span class="nf">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'MKDIR: '</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'GET:   '</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s">'html5lib'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">'manga-page'</span><span class="p">)[</span><span class="s">'src'</span><span class="p">]</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path</span>     <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'GET:   '</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'CREATE:'</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>

    <span class="n">url</span>  <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'user-agent'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'Mozilla/5.0'</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'.btn-reader-page a'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">'href'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span> <span class="o">+</span> <span class="s">'/{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">save_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">if __name__</code> line isn’t needed but I like using it as it forces an 
extra level of indentation which I think gives separation from the functions.</p>

<p>So we are extracting the comic and chapter titles from the URL so we create our own 
directory structure (using <code class="highlighter-rouge">makedirs()</code>) to save the image files into. If we were to
download multiple chapters of even different comics we could have duplicate filenames
so it’s a good idea to keep them organized.</p>

<p>The reason for our own <code class="highlighter-rouge">makedirs()</code> function and the <code class="highlighter-rouge">try / except</code> inside it is that 
<code class="highlighter-rouge">os.makedirs()</code> will raise an exception if any item in the path already exists. Starting
with Python 3.2 you can pass <code class="highlighter-rouge">exist_ok=True</code> to prevent this which would mean you can 
remove the <code class="highlighter-rouge">def makedirs()</code> completely and just use <code class="highlighter-rouge">os.makedirs(dirname, exist_ok=True)</code></p>

<p>You may notice here that we’re requesting the first page twice. This was just to avoid
code duplication.</p>

<a name="splat"></a>
<h2 class="section-header">
  <span id="splat"></span>
  <a class="anchor" href="#splat">splat</a>
</h2>

<p>Whilst on the topic let’s give a quick explanation of the <code class="highlighter-rouge">dirname</code> line:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre>
</div>

<p>So we split the URL on <code class="highlighter-rouge">/</code> and take the 3rd last and 2nd last items.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s">'http://mangastream.com/r/demons_plan/010/3997'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="s">'demons_plan'</span><span class="p">,</span> <span class="s">'010'</span><span class="p">]</span>
</code></pre>
</div>

<p>If the URL had a trailing <code class="highlighter-rouge">/</code> however we would have an extra item in the
list so our indexing would break:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s">'http://mangastream.com/r/demons_plan/010/3997/'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="s">'010'</span><span class="p">,</span> <span class="s">'3997'</span><span class="p">]</span>
</code></pre>
</div>

<p>This is why we use <code class="highlighter-rouge">strip('/')</code> to remove and trailing slashes. <code class="highlighter-rouge">strip()</code> also
removes leading matches too and there are <code class="highlighter-rouge">lstrip()</code> and <code class="highlighter-rouge">rstrip()</code> to target
one side specifically. Leading slashes would be an error in this case so it doesn’t
matter if we use <code class="highlighter-rouge">strip()</code> or <code class="highlighter-rouge">rstrip()</code> and <code class="highlighter-rouge">strip()</code> is less typing.</p>

<p>So the result of our <code class="highlighter-rouge">split()</code> is a 2 element list. <code class="highlighter-rouge">os.path.join()</code> however, doesn’t expect a list.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">'foo'</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">])</span>
<span class="p">[</span><span class="s">'foo'</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="s">'foo'</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">])</span>
<span class="s">'foo/bar'</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">*</code> (sometimes called <em>“splat”</em>) unpacks the list passing in 2 arguments 
instead as if we called:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">)</span>
<span class="s">'foo/bar'</span>
</code></pre>
</div>

<p>Incidentally, <code class="highlighter-rouge">**</code> exists for unpacking dicts.</p>

<a name="what-now"></a>
<h2 class="section-header">
  <span id="what-now"></span>
  <a class="anchor" href="#what-now">What now?</a>
</h2>

<p>There’s no error checking for the <code class="highlighter-rouge">sys.argv[1]</code> you could use 
<a href="https://docs.python.org/3/howto/argparse.html">argparse</a> or
<a href="http://click.pocoo.org/">click</a> to build a command-line interface.</p>

<p>There is a dropdown for the chapter list however it doesn’t contain them all.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"btn-group btn-reader-chapter"</span><span class="nt">&gt;</span>
...
  <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"http://mangastream.com/manga/demons_plan"</span><span class="nt">&gt;</span>Full List<span class="nt">&lt;/a&gt;</span><span class="err">&lt;</span>/li
</code></pre>
</div>

<p>The full list is available from an <code class="highlighter-rouge">&lt;a&gt;</code> tag in containing <code class="highlighter-rouge">&lt;div&gt;</code>. You could build
a URL list of each chapter. That is moving into “crawling” territory though and in 
such cases using something like <a href="http://doc.scrapy.org/">Scrapy</a> might be a good idea.</p>

<p>Perhaps we’ll discuss such an approach in a future part of this article.</p>

<p><a href="https://github.com/kaijento/code/blob/master/webscraping/mangastream.com/mangastream.com.py">mangastream.com.py</a></p>

<p>In <a href="/2017/03/23/web-scraping-mangastream.com-2/">Part 2</a> we’ll convert 
the Python code to a bash script/function that uses <code class="highlighter-rouge">curl</code> and <code class="highlighter-rouge">grep</code> aka 
doing it <em>“The Wrong Way”</em>.</p>

</div>

  
    <div class="post-navs row">
      
        <div class="col-md-6 post-nav">
          <h3 class="section-header">
            Older
            <!--<span class="text-muted"> &middot; </span>-->
            <a href="/archive">View Archive (54)</a>
          </h3>
          <h2 class="post-title-link"><a href="/2017/03/22/python-add-line-to-file-if-not-already-there/">Python: add line to file if not already there</a></h2>
          <p class="preview">So the goal is to search through a file looking for a line that matches a
particular pattern. If there is no match add a new line to the end 
of the file i.e. <em>“append a line to a file”<em>.</em></em></p>


        </div>
      
      
        <div class="col-md-6 post-nav">
          <h3 class="section-header">
            Newer
            
          </h3>
          <h2 class="post-title-link"><a href="/2017/03/23/web-scraping-mangastream.com-2/">Web scraping: mangastream.com #2</a></h2>
          <p class="preview">In <a href="/2017/03/23/web-scraping-mangastream.com/">Part 1</a> 
we saw how to scrape all of the comic images from a particular “chapter” 
on a mangastream.com comic such as:</p>


        </div>
      
    </div>
  

<div class="post-footer">
  <center><strong>Hello? Is it me you're looking for?</strong> 
<p>
  <a href="mailto:karl.genockey.thornton@gmail.com">e-mail</a>
  <a href="https://github.com/kaijento">github</a>
  <strong>♥</strong> 
  <a href="https://paypal.me/kaijento">paypal</a>
  <a href="https://twitter.com/kaijento">twitter</a> 
</p>
<p>
<small>1GVHM3rfQ46k15RZsfnE4xzmKk7NCFwRaT</small>
</p>
</center>

</div>

          </div>
        
      </div>
      <div class="row footer">
        <div class="col-sm-12 text-center">
          &copy;2017.
Built with <a href="http://jekyllrb.com/">Jekyll</a> and
<a href="https://github.com/ellekasai/shiori">Shiori Theme</a>.

        </div>
      </div>
    </div>
    
  </body>
</html>
